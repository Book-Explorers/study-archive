# 2. 단위 테스트란 무엇인가

### 단위 테스트의 두 분파

단위 테스트의 정의에 관한 해석 차이가 생겼고 결국 두 분파로 나뉨.

**고전파(classical school)**

모든 사람이 단위 테스트와 테스트 주도 개발에 원론적으로 접근하는 방식이기 때문에 고전파로 불림.

**런던파(london school)**

런던의 프로그래밍 커뮤니티에서 시작.

### 단위 테스트의 정의

단위 테스트에서 가장 중요한 세 가지 속성이 있다.

- 작은 코드 조각(단위)을 검증
- 빠르게 수행
- 격리된 방식으로 처리하는 자동화된 테스트

두 분파를 구분할 수 있게 해주는 근원적 차이는 세 번째인 격리 문제를 어떻게 다루는지에 대한 의견 차이에서 시작.

### 격리 문제에 대한 런던파의 접근

런던파에서는 테스트 대상을 협력자에서 격리하는 방식으로 코드 조각(단위)을 검증.

즉, 하나의 클래스가 다른 클래스 또는 여러 클래스에 의존하면 이 모든 의존성을 테스트 대역(test double)으로 대체한다.

이 방법의 이점은 모든 의존성을 테스트 대역으로 대체했기 때문에 테스트가 실패하면 코드베이스의 어느 부분이 잘못 됐는지 확실히 알 수 있다는 것이다. 또 다른 이점으로는 테스트 대상이 의존하는 클래스가 또 다른 의존성을 갖고 있는 객체 그래프 형식을 갖게 되는데 테스트 대역을 사용하면 객체 그래프를 만들지 않고(의존성에 의존성을 다룰 필요없이) 테스트할 수 있다는 이점이 있다. 이러한 이점 덕분에 테스트 대상 클래스당 하나의 테스트 클래스가 있는 구조를 가져갈 수 있다.

### 격리 문제에 대한 고전파의 접근

고전파는 단위 테스트를 공유 의존성에 대해서만 격리하여 순차적, 병렬적으로 실행해도 각 테스트의 결과가 서로의 결과에 영향을 미치지 않게 검증하는 방식. 그렇지 않으면 코드베이스의 문제로 테스트가 실패하는게 아니라 테스트의 간섭 때문에 테스트가 실패할 수 있다. 즉, 단위 테스트 끼리 격리한다고 볼 수 있다.

공유 의존성을 격리(대체)하는 또 다른 이유는 테스트의 실행 속도를 높이는데 있다.

대표적인 공유 의존성은 데이터 베이스나 외부 API등이 있다. 이 의존성들은 대부분 프로세스 외부에 존재하기 때문에 실행속도가 느리다는 단점이 있는데 이 부분을 테스트 대역으로 대체 함으로써 단위 테스트의 두 번째 속성인 빨리 실행해야하는 부분을 지킬 수 있다. 데이터 베이스나 외부 API를 실제로 호출하는 테스트는 통합 테스트로 분류된다.

- **공유 의존성(협력자)**
    - 테스트 간에 공유되고 서로의 결과에 영향을 미칠 수 있는 의존성.
- **비공개 의존성**
    - 공유하지 않는 의존성이며 **변경 가능한 의존성(협력자)**과 **값 객체(Value Object)**로 나뉨.
- **프로세스 외부 의존성**
    - 애플리케이션 외부에서 실행되는 의존성.

### 단위 테스트의 런던파와 고전파

**런던파와 고전파의 격리에 대한 접근법, 단위의 크기, 테스트 대역 사용에 대한 요약 표**

|  | 격리 주체 | 단위의 크기 | 테스트 대역 사용 대상 |
| --- | --- | --- | --- |
| 런던파 | 단위 | 단위 클래스 | 불변 의존성를 제외한 모든 의존성 |
| 고전파 | 단위 테스트 | 단위 클래스 또는 클래스 세트 | 공유 의존성 |

### 고전파와 런던파의 비교

이 책의 필자는 고전파를 더 선호한다고 한다. 그 이유는 런던파의 단위 테스트보다 고품질의 테스트를 작성할 수 있고 프로젝트의 지속 가능한 성장을 달성하는데 더 적합하기 때문이라고 한다.

목을 사용하는 런던파의 단위 테스트는 취약성이 존재하기 때문에 고전파의 단위 테스트보다 불안정한 경향이 있다고 한다. 5장에서 자세히 설명한다고 한다.

**런던파의 주요 장점**

- 한 번에 한 클래스만 테스트하기
    - 런던파는 클래스를 단위로 간주한다. OOP에서는 클래스 보다 작은 단위가 없기 때문에 모든 코드베이스의 기초에 위치한 원자 빌딩 블록으로 간주한다.
    - 입자성(granularity)이란 단위를 나누는 정도를 의미함. 입자성이 높으면 더 작은 단위로 나뉜거고 입자성이 작으면 큰 단위로 나뉜거다.
    - 테스트가 단일 동작 단위만 검증하면 좋은 테스트라 볼 수 있다.
- 상호 연결된 클래스의 큰 그래프를 단위 테스트하기
    - 고전파는 공유 의존성을 제외한 전체 객체 그래프를 직접 만들어야 하는 반면에 불변 의존성을 제외한 모든 의존성을 테스트 대역을 대체되기 때문에 객체 그래프의 크기와 상관없이 편하게 테스트가 가능하다.
    - 대게 객체 그래프가 커진 것은 코드 설계에 문제가 있을 가능성이 높다. 테스트 대역을 사용하는 런던파의 단위 테스트는 이러한 문제를 감추기 때문에 코드 설계에 문제를 사전에 파악하지 못 할 수 있다.
- 버그 위치 정확히 찾아내기
    - 불변 의존성을 제외한 모든 의존성을 테스트 대역으로 대체하기 때문에 테스트가 실패하면 코드베이스의 어느 부분이 잘못 됐는지 확실히 알 수 있다. 또한 버그가 하나의 테스트 뿐만 아니라 많은 테스트에 실패를 야기한다면 많은 시스템이 이 코드에 의존하고 있다는 것을 알 수 있다.

런던파는 하양식 TDD, 고전파는 상향식 TDD 방식을 사용해서 테스트 코드를 작성한다.

런던파와 고전파의 가장 큰 차이는 런던파는 테스트가 구현에 더 자주 결합된다는 점이다.

### 두 분파의 통합 테스트

단위 테스트에서 가장 중요한 세 가지 속성이 있다했다.

런던파

- 작은 코드 조각을 검증
- 빠르게 수행
- 불변 의존성을 제외한 모든 의존성을 테스트 대역으로 격리

고전파

- 단일 동작 단위를 검증
- 빠르게 수행
- 공유 의존성을 격리하여 다른 테스트와  별도로 처리

이 세 가지 중 한 가지라도 지키지 못 하는 테스트는 통합 테스트로 간주된다.

엔드 투 엔드 테스트는 통합 테스트의 일부이며 더 많은 의존성(외부 존속성 등)을 포함한다.

런던파 입장에서는 고전파는 통합 테스트라고 느낄 수 있다.