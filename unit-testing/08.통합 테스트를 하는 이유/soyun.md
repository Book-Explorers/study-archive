# 08 통합테스트를 하는 이유

메시지 버스란?

출처: https://stackoverflow.com/questions/7793927/message-queue-vs-message-bus-what-are-the-differences

A **Message Bus** is a messaging infrastructure to allow different systems to communicate through a **shared set of interfaces**(**message bus**).

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/fe9b8166-b5d9-4798-b656-ce481ba3f932/0aeb5a9a-7f44-4d2e-85fa-0e85ba6ae9d4/Untitled.png)

- vs 메시지 큐란?
    
    

https://enterprisecraftsmanship.com/posts/ocp-vs-yagni/

사실상 이 목차는 비관리 의존성만 목으로 처리하라는 걸 설명하기 위해 

비관리 의존성의 예시로 메시지버스를 보여줬음

<aside>
💡 8장에서 다루는 내용
- 통합 테스트의 역할 이해
- 테스트 피라미드의 개념 살피기
- 가치있는 통합 테스트 작성

</aside>

통합테스트의 역할을 알고 언제 사용하는게 좋을지 알아야한다.

### 8.1 통합테스트란?

단위테스트는 

- 단일 동작단위 검증
- 빠르게 수행
- 다른 테스트와 별도로 처리

3가지 요구사항 모두를 충족하는 테스트이다. 이중 하나라도 충족하지 못하면 통합 테스트이다. 

| 단위테스트 | 통합테스트 |
| --- | --- |
| 도메인 모델, 알고리즘을 다룬다. | 프로세스 외부 의존성, 도메인 모델을 연결하는 코드(컨트롤러)를 확인한다. |
|  | 회귀방지가 단위 테스트보다 우수하다.
(애플리케이션 코드와 라이브러리의 코드를 모두 포함하기 때문) |
|  | 제품코드와 결합도가 낮아 리팩터링 내성도 우수하다 |
| 단위테스트의 할일:
비즈니스 시나리오의 예외 상황을 확인한다.  | 통합테스트의 할일:
주요 흐름, 단위테스트가 다루지 못하는 기타 예외 상황을 다룬다. |

*회귀방지: 코드가 수정되었을 때 제대로 동작되지 않는 회귀를 방지하는 것.

### 8.1 통합테스트와 빠른 실패

좋지 않은 테스트 작성하는 것보다 테스트를 작성하지 않는 것이 좋다. 

가치가 별로 없는 테스트는 좋지 않은 테스트이다. 

빠른 실패 원칙 : 버그를 빨리 나타내게 하는 것. 

이 원칙은 다음을 통해 애플리에키엿늬 안정성을 높인다. 

- 피드백 루프 단축 : 버그 빨리 발견해 쉽게 해결
- 지속성 상태보호 : 버그는 애플리케이션 상태를 손상시킨다. 빨리 실패하면 손상 확산을 막을 수 있다.

### 8.2 어떤 프로세스 외부 의존성을 직접 테스트해야하는가?

통합 테스트는 

시스템이 프로세스 외부 의존성과 어떻게 통합하는지를 검증한다. 

검증하는 방법은 두 가지가 있다. 

실제 프로세스 외부 의존성을 사용하거나 해당 의존성을 목으로 대체하는 것이다. 

### 8.2 프로세스 외부 의존성의 두가지 유형

| 관리 의존성 | 비관리 의존성 |
| --- | --- |
| 다른 애플리케이션이 접근할 수 없는 
프로세스 외부 의존성
 | 다른 애플리케이션이 접근할 수 있는
프로세스 외부 의존성 |
| 관리 의존성과의 상호작용을 
외부에서 관찰할 수 없다.  | 비관리 의존성과의 상호작용은 
외부에서 관찰하라 수 있다. |
| ex.애플리케이션 데이터베이스 (애플리케이션 통해서만 접근가능 ) | ex. SMTP 서버나 메시지 버스 |
| 관리 의존성과의 통신은
구현 세부 사항이다. | 비관리 의존성과의 통신은
식별할 수 있는 동작이다. |
| 통합테스트에서 관리의존성은
실제 인스턴스를 사용하라. | 통합테스트에서 비관리 의존성은 
목으로 대체하라. |

때때로 프로세스 외부 의존성은 관리 의존성과 비관리 의존성 모두의 속성을 나타낸다. 

예로 다른 애플리케이션이 접근할 수 있는 데이터베이스가 있다. 

의존성 중 관찰할 수 있는 부분을 비관리 의존성으로 취급하라. 즉 테스트에서 해당 부분을 목으로 대체하라. 

나머지 의존성은 관리 의존성으로 취급하라. 상호 작용이 아닌 최종상태를 검증하라.

### 8.3 엔드 투 엔드 테스트는 어떤가?

샘플 프로젝트에는 엔드 투 엔드 테스트가 없을 것이다. API로 시나리오를 엔드 투 엔드 테스트하면 배포해서 모두 작동하는 버전의 API로 테스트하게 되고, 이는 어떤 프로세스 외부 의존성도 목으로 대체하지 않는 것을 의미한다.

반면 통합 테스트는 동일한 프로세스 내에서 애플리케이션을 호스팅하고 비관리 의존성을 목으로 대체한다.

### 8.4 의존성 추상화를 위한 인터페이스 사용

인테페이스 남발하지 말라! 단일 구현을 위한 인터페이스는 추상화가 아니다. 

구체 클래스를 쓰는 것이 결합도가 훨씬 낮다.

필요하지 않는 기능에 시간 보내지 말라 YAGNI : you aren’t gonna need it

또한 프로젝트 코드는 적을수록 좋다. 

### 8.4 프로세스 외부 의존성에 인테페이스를 사용하는 잉는 무엇인가?

목을 사용하기 위함이다. 

비관리 의존성만 목으로 처리하기 때문에 비관리 의존성에 대해서만 인터페이스를 써라. 

### 8.5 통합테스트 모범 사례

통합 테스트를 최대한 활용하는데 도움되는 지침

- 도메인 모델 경계 명시하기
    - 도메인 모델을 코드베이스에서 명시적이고 잘 알려진 위치에 두기.
    - 도메인 클래스와 컨트롤러 사이의 명확한 경계를 두기
- 애플리케이션 내 계층 줄이기
    - 간접 계층을 적게 사용하기
    - 도메인 모델, 애플리케이션 서비스계층 (컨트롤러), 인프라 계층(도메인 모델에 속하지 않는 알고리즘과 프로세스 외부 의존성에 접근할 수 있는 코드,데이터베이스 저장소,ORM매핑, SMTP게이트웨이 등..) 으로 구성
- 순환 의존성 제거하기
    - 순환의존성circular dependency 둘 이상의 클래스가 제대로 작동하고자 직간접적으로 서로 의존하는 것을 말한다.
    - 대표적 예) 콜백
    - 인터페이스에 의존하거나 호출하는 대신 작업 결과를 일반 값으로 리턴하게 하라

### 8.5 테스트에서 다중 실행 구절 사용

하나의 통합 테스트가 너무 커지지 않게 각 실행을 고유의 테스트로 추출해 테스트를 나눠라. 

각 테스트가 단일 동작 단위에 초첨을 맞추게 하라

예외로 원하는 상태로 만들기 어려운 프로세스 외부 의존성으로 작동하는 테스트가 있으면, 여러 동작을 하나의 테스트로 묶어서 문제가 있는 프로세스 외부 의존성에 대한 상호 작용 횟수를 줄이는 것이 유리하다. 

### 8.6 로깅 기능 테스트

- 로깅 기능 테스트해야하는가?

로깅이 식별할 수 있는 동작인지 구현세부사항인지에 따라 다르다. 

| 지원로깅 support logging | 진단로깅 diagnostic logging |
| --- | --- |
| 지원 담당자나 시스템 관리자가 추적할 수 있는 메시지를 생성한다.  | 개발자가 애플리케이션 내부 상황을 파악할 수 있도록 돕는다. |
| 식별할 수 있는 동작 | 구현 세부 사항 |
| 목으로 처리 |  |
- 구조화된 로깅

로그 데이터 캡처 ,로그 렌더링을 분리하는 로깅 기술이다. 평범한 로그 파일이나 JSON또는 CSV 파일과 같이 여러 렌더링을 설정할 수 있다.

지원로깅은 테스트하지만 진단로깅은 가능하면 테스트하고 제거한다. 

지원로깅을 테스트하는 것은 다른 비관리 의존성(메시지 버스)을 테스트하는 것과 다르지 않다. 

### 8.6 로깅이 얼마나 많으면 충분한가?

과도한 로깅은 코드를 혼란스럽게 한다. 도메인 모델에서는 진단로깅을 절대 사용하지 않도록 한다. 일시적으로 사용하고 삭제하라. 

### 8.6 로거 인스턴스를 어떻게 전달하는가?

- 정적 메서드를 통해 전달.
    - 안티패턴임.
        - 의존성이 숨어있고 변경어렵다.
        - 테스트가 더 어려워진다.
- 클래스 생성자를 통해 전달
    - 로거를 명시적으로 주입
