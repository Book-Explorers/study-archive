# 7. 가치 있는 단위 테스트를 위한 리팩토링

## 7장에서 다루는 내용

- 네 가지 코드 유형 알아보기
- 험블 객체 패턴
- 가치 있는 테스트 작성

## 좋은 단위 테스트 스위트의 속성

좋은 단위 테스트 스위트의 속성은 다음과 같습니다.

- 개발 주기에 통합돼 있다.
- 코드베이스 중 가장 중요한 부분만을 대상으로 한다.
- 최소한의 유지비로 최대의 가치를 끌어낸다. 이를 달성하려면 다음을 할 수 있어야 한다.
    - 가치 있는 테스트, 별로 가치 없는 테스트 식별하기.
    - 가치 있는 테스트 작성하기

4장에서는 회귀 방지, 리팩토링 내성, 빠른 피드백, 유지 보수성이라는 4대 요소를 통해 가치 있는 테스트를 알아봤다. 그리고 5장에서는 4대 요소 중 가장 중요한 리팩토링 내성을 자세히 살펴봤다. 단위 테스트와 코드 베이스는 서로 매우 얽혀 있기 때문에 코드베이스에 노력을 기울이지 않고서는 가치 있는 테스트를 만들 수 없다. 6장에서 코드베이스를 함수형 아키텍처로 재설계하고 출력 기반 테스트를 적용해 보았다.

이 장에서는 함수형 아키텍처를 사용할 수 없는 애플리케이션을 포함해 더 넓은 범위의 애플리케이션에 가치 있는 테스트를 작성하는 방법과 관련해 실용적인 지침을 알아본다.

## 리팩토링할 코드 식별하기

테스트 코드와 제품 코드는 본질적으로 관련돼 있기 때문에 코드 베이스를 리팩토링하지 않고서는 테스트 스위트를 크게 개선할 수 없다. 이 절에서는 리팩토링의 방향을 설명하고자 코드를 네 가지 유형으로 분류하는 방법을 소개한다.

### 코드의 네 가지 유형

모든 제품 코드는 다음과 같이 2차원으로 분류할 수 있다.

- 복잡도 또는 도메인 유의성
    - 코드 복잡도(code complexity)는 코드 내 의사 결정(분기) 지점 수로 정의한다. 이 숫자가 클 수록 복잡도는 높아진다.
    - 도메인 유의성(domain significance)은 코드가 프로젝트의 문제 도메인에 대해 얼마나 의미있는지를 나타낸다. 도메인 계층의 모든 코드는 최종 사용자의 목표와 직접적인 연관성이 있으므로 도메인 유의성이 높다. 반면에 유틸리티 코드는 그런 연관성이 없다.
    - 복잡한 코드와 도메인 유의성이 높은 코드는 회귀 방지가 뛰어나기 때문에 단위 테스트에서 가장 이롭다.
- 협력자 수
    - 클래스 또는 메서드가 가진 협력자 수를 의미한다.
    - 가변 의존성이나 프로세스 외부 의존성을 많이 가진 코드는 테스트 크기에 따라 유지 보수성 지표가 달라지며 테스트 비용이 많이 든다.
    - 도메인은 프로세스 외부 의존성을 가지면 안된다. 프로세스 외부 의존성을 가진 모든 통신은 도메인 계층 외부 클래스에 위임하는 것이 좋다. 그러면 도메인 클래스는 프로세스 내부 의존성에서만 동작하게 된다.
    - 리팩토링 내성을 잘 지키려면 애플리케이션 경계를 넘는 상호 작용 중 외부 프로세스에서 사이드 이펙트가 보이는(식별 가능한 동작이 보이는지를 의미) 경우에만 목을 사용해서 상호 작용을 검증해야한다.

코드의 복잡도, 도메인의 유의성, 협력자 수의 조합으로 아래 사진 처럼 네 가지 코드 유형을 볼 수 있다.

![스크린샷 2024-03-20 오후 9 46 17](https://github.com/rbsks/unit_test/assets/67041069/db0701af-367e-4443-a608-988d2eb40f42)

- 도메인 모델과 알고리즘
    - 코드에 협력자가 거의 없어서 테스트의 유지비가 적고 해당 코드가 복잡하거나 중요한 로직을 수행해서 테스트의 회귀 방지가 향상되기 때문에 단위 테스트 작성 시 가장 이롭고 가치 있다.
- 간단한 코드
    - 테스트할 가치가 0에 가깝다. 예를 들면 단순한 생성자에 대한 테스트 코드가 있다.
- 컨트롤러
    - 3부에 등장하는 통합 테스트의 일부로서 간단히 테스트해야 한다.
- 지나치게 복잡한 코드
    - 단위 테스트하기 어려워서 가장 문제가 되는 유형이다.
    - 이러한 코드는 도메인 모델 및 알고리즘과 컨트롤러라는 두 부분으로 나누는 것이 일반적이다.
    - 지나치게 복잡한 코드를 피하고 도메인 모델과 알고리즘만 단위 테스트하는 것이 매우 가치 있고 유지 보수가 쉬운 테스트로 가는 길이다.

### 험블 객체 패턴을 사용해서 지나치게 복잡한 코드 분할하기

지나치게 복잡한 코드를 쪼개려면, 험블 객체(Humble Object) 패턴을 써야한다.

테스트 대상 코드의 로직을 테스트하려면, 테스트가 가능한 부분을 둘러싼 얇은 험블 래퍼(Humble Wrapper)를 만들어서 단위 테스트가 수월하게 끔 만들어야 한다. 이 방법은 헥사고날 아키텍처에와 함수형 아키텍처에서 언급됐던 애플리케이션 서비스 계층(가변 셸)과 도메인 계층(함수형 코어)을 나누는 것과 동일한 패턴이다.

도메인 계층과 함수형 코어는 도메인 모델 및 알고리즘 영역에 속하며, 애플리케이션 서비스 계층과 가변 셸은 컨트롤러 영역에 속한다. 또한 험블 객체 패턴을 사용하면 단일 책임 원칙(SRP)를 지키기 수월하기 때문에 비즈니스 로직(도메인)을 거의 모든 것과 분리할 수 있다. 코드가 깊고(복잡하거나 중요함) 넓으면(많은 협력자와 작동함) 테스트 하기 쉽지 않다. 그러므로 둘 중 하나의 책임만 가지도록 분리해서 코드 복잡도를 낮추어 테스트 하기 수월하게 하는 것이 중요하다.

## 가치 있는 단위 테스트를 위한 리팩토링하기

위에서 언급한 내용 처럼 도메인 모델에서 외부 시스템과 직접 호출하는 책임을 험블 객체 패턴을 사용해서 어플리케이션 서비스 레이어 쪽으로 책임을 옮기고 도메인 모델은 프로세스 내부에 존재하는 다른 도메인 클래스나 단순 값에만 의존하고 협력하여 도메인의 내부 발생하는 사이드 이펙트가 메모리에 남아 있게 끔 리팩토링 하여 테스트가 외부 의존성의 상호 작용 검증을 할 필요가 없고 통신 기반 테스트에 의존할 필요가 없게 해야 한다. 즉, 출력 기반 테스트와 상태 기반 테스트로 모든 검증을 수행 하게 끔 해야 좋은 단위 테스트를 작성할 수 있다.

[좋은 테스트를 하기 위한 코드 작성 법 예제 링크 첨부](https://github.com/rbsks/unit_test)

## 컨트롤러에서 조건부 로직 처리

비즈니스 로직과 오케스트레이션의(많은 협력자와 작동하는 코드) 분리는 다음과 같이 비즈니스 연산이 세 단계로 있을 때 가장 효과적이다.

- 저장소에서 데이터 검색(오케스트레이션)
- 비즈니스 로직 실행(비즈니스 로직)
- 데이터를 다시 저장소에 저장(오케스트레이션)

그러나 이렇게 단계가 명확하지 않은 경우가 훨씬 더 많다. 도메인의 비즈니스 로직을 실행 후 그 결과를 기반으로 애플리케이션 서비스 계층에서 프로세스 외부 의존성을 통해 추가로 데이터를 조회해야 할 수도 있다. 이러한 상황에서는 아래 구조 중 세 번째 구조를 사용하여 문제를 완화 시킬 수 있다.

- 애플리케이션 서비스 계층의 단순함과 도메인의 모델의 테스트 유의성을 지킬 수 있는 구조
    - 외부에 대한 모든 읽기와 쓰기를 애플리케이션 서비스 계층으로 밀어낸다. 이 방법은 ‘읽고-결정하고-실행하기’ 구조를 유지하지만 도메인에서 의사결정을 할 수 있게 모든 데이터를 읽어와야하기 때문에 성능이 저하될 수 있다.
- 애플리케이션 서비스 계층의 단순함과 성능을 지킬 수 있는 구조
    - 도메인 모델에 프로세스 외부 의존성을 주입하고 비즈니스 로직에서 추가 데이터를 조회할 수 있게 한다. 이 방법은 성능은 유지하고 애플리케이션 서비스 계층을 단순하게 하지만 도메인 모델의 테스트 유의성을 떨어트린다.
- 도메인 모델의 테스트 유의성과 성능을 지킬 수 있는 구조
    - 의사 결정 프로세스 단계를 더 세분화한다. 이 방법은 성능과 도메인 모델 테스트 유의성에 도움을 주지만, 애플리케이션 서비스 계층이 단순하지 않다. 이때 도메인 모델에 대한 수준 높은 캡슐화를 적용해서 의사 결정 지점을 도메인 계층으로 통합하면 애플리케이션 서비스 계층에 의사 결정 프로세스를 간단하게 할 수 있다.

애플리케이션 서비스 계층의 단순함은 의사 결정(분기) 지점이 얼마나 있느냐에 따라 결정되고, 성능은 프로세스 외부 의존성에 대한 호출 수에 의해 결정된다. 마지막으로 도메인 모델의 테스트 유의성은 도메인 클래스의 협력자 수와 유형에 따른 함수에 의해 결정된다.

### 도메인 이벤트를 사용해 도메인 모델 변경 사항 추적

도메인 모델에 존재하는 상태에 대한 변경을 추론하기 어려울 때가 있다. 그러나 애플리케이션에서 정확히 무슨 일이 일어났는지 외부 시스템에 알려야하는 상황이 생길 수 있기 때문에 변경 상태를 추론하는 것이 중요할지도 모른다. 이때 도메인 이벤트를 사용하여 상태 변경에 대한 추적을 구현할 수 있다. 구현 관점에서 도메인 이벤트는 외부 시스템에 통보하는 데 필요한 데이터가 포함된 클래스다. 도메인은 인스턴스 변수로 이 클래스를 가지고 특정 이벤트가 발생할 때 도메인 이벤트의 상태를 변경 시키거나 값을 추가한다. 도메인이 비즈니스 로직 수행을 완료하면 애플리케이션 서비스 계층은 도메인 이벤트를 확인하여 이벤트를 처리하면 된다. 이렇게 적용한 도메인 이벤트는 출력기반 테스트 + 상태 기반 테스트를 통해 쉽게 테스트할 수 있다.

### [Unit Test 깃헙 예제 링크](https://github.com/rbsks/unit_test)