## 다루는 내용

## 1단계) 문제 이해 및 설계 범위 확정

- 사용자가 입력하는 단어의 자동완성될 검색어의 위치. 첫 부분인가? 중간 부부인가?
- 몇 개의 자동완성 검색어가 표시되야 하는가?
- 자동완성 검색어 5개를 고르는 기준은 무엇인가?
- 맞춤법 검사 기능을 제공해야 하는가?
- 질의는 영어인가?
- 대문자나 특수 문자 처리도 해야 하는가?
- 얼마나 많은 사용자를 지원해야 하는가?

---

### 요구사항

- 빠른 응답속도: 페이스북 검색어 자동완성 시스템 문서는 100ms 이내
- 연관성: 자동완성되어 출력되는 검색어는 사용자가 입력한 단어와 연관된 것
- 정렬: 인기도 등 순위 모델에 의한 정렬
- 규모 확장성: 많은 트래픽을 감당할 수 있도록 확장 가능해야 함
- 고가용성: 시스템 일부에 장애가 발생하거나, 느려지거나, 예상치 못한 네트워크 문제가 생겨도 계속 사용 가능해야 함

### 개략적 규모 측정

- 검색창에 글자를 입력할 때마다 백엔드에 요청

## 2단계) 개략적 설계안 제시 및 도의 구하기

- 데이터 수집 서비스: 사용자가 입력한 질의를 실시간으로 수집하는 시스템
- 질의 서비스: 주어진 질의에 다섯 개의 인기 검색어를 정렬해 놓는 서비스

### 데이터 수집 서비스

- 질의문과 사용빈도를 저장하는 빈도 테이블
- 검색어를 입력할 때마다 테이블에 기록

### 질의 서비스

- 검색어와 횟수를 저장하는 테이블, 빈도로 정렬
- LIKE 검색어로 데이터 조회 → 성능 저하

```sql
SELECT * FROM frequency_table
WHERE query LIkE 'prefix%'
ORDER BY frequency DESC
LIMIT 5;
```

## 3단계) 상세 설계

### 트라이 자료구조

- 트리구조
- 시간복잡도: O(p) + O(c) + O(clogc)
    - 접두어 찾는 O(p)
    - 유효한 검색 문자열 찾는 O(c)
    - 유효 노드들을 정렬하여 가장 인기 있는 검색어 k개 찾는 O(clogc)

트라이 알고리즘은 최악의 경우 k개 결과를 얻기 위해 전체 트라이를 검색해야하는 일이 생김. 이를 해결하기 위해

- 접두어의 최대 길이 제한: 검색창에 긴 검색어를 입력하는일 적음 → 위의 O(p) 를 상수 O(1)로 바꾸기
- 각 노드에 인기 검색어를 캐시: 각 노드간 k개의 인기 검색어 저장 → 각 노드에 질의어를 저장할 공간이 많이 필요하다는 단점 → 빠른속도를 얻는 대신 저장 공간 희생

### 데이터 수집 서비스

타이핑을 할 때마다 실시간으로 데이터 수정하는 것이 실용적이지 않은 두 가지 이유

- 매일 수천만 건의 질의가 입력될 텐데 그 때마다 트라이를 갱신하면 질의 서비스는 심각하게 느려짐
- 일단 트라이가 만들어지고 나면 인기 검색어는 그다지 자주 바뀌지 않을 것. 그래서 트라이를 자주 갱신할 필요가 없음

보통 트라이를 만드는 데 쓰는 데이터는 데이터 분석 서비스나 로깅 서비스로부터 온다.

**데이터 분석 로그**

**로그 취합 서버**

데이터 취합 방식은 서비스 용례에 따라 다르게

- 트위터: 실시간 애플리케이션이므로 결과를 빨리 보여주는게 좋음 → 주기를 짧게
- 대부분의 경우 일주일에 한 번 정도로 로그 취합

즉, 실시간성의 유무에 따라 판단하기

**취합된 데이터**

**작업 서버**

**트라이 캐시**

**트라이 데이터베이스**

- 문서 저장소 ex) Mongo db
- 키-값 저장소 ex) redis

**질의 서비스 최적화 방안**

- AJAX 요청
- 브라우저 캐싱
- 데이터 샘플링

### 트라이 연산

**트라이 생성**

**트라이 갱신**

- 매주 한 번 갱신
- 트라이의 각 노드를 개별적으로 갱신

**검색어 삭제**

- 위험한 질의어(욕설 등)를 자동완성 결과에서 제거
- 크라이 캐시 앞에 필터 계층을 두어 부적절한 질의어를 반환되지 않도록

### 저장소 규모 확장

- 샤딩

## 4단계) 마무리

- 다국어라면? 유니코드(세상에 존재하는 모든 문자 체계를 지원하는 표준 인코딩 시스템)
- 국가별 인기 검색어가 다르다면? CDN
- 실시간으로 변하는 검색어의 추이를 반영하려면? 이 장의 설계안으로는 힘듦
