# 9. 목 처리에 대한 모법 사례

## 9장에서 다루는 내용

- 목의 가치를 극대화하기
- 목을 스파이로 교체하기
- 목 처리에 대한 모범 사례

목은 테스트 대상 시스템과 의존성 간의 상호 작용을 모방하고 검사하는 데 도움이 되는 테스트 대역이다. 목은 비관리 의존성에만 적용되어야 하며,  다른 것에 목을 사용하면 리팩토링 내성이 저하되는 테스트가 된다.

## 목의 가치를 극대화하기

### 시스템 끝에서 상호 작용 검증하기

목을 사용할 때는 항상 시스템 끝에서 비관리 의존성과의 상호 작용을 검증해야한다. 이렇게 하면 테스트 중에 실행되는 코드의 양이 많아지기 때문에 회귀 방지와 리팩토링 내성이 향상 된다.

### 목을 스파이로 대체하기

스파이는 목과 같은 목적을 수행하는 테스트 대역이다. 수동으로 작성한다는것이 목과의 유일한 차이다. 스파이를 사용하면 검증 단계에서 코드를 재사용할 수 있으며 여러 가지 검증을 묶어 응집도를 높일 수 있다. 또한 테스트 크기를 줄이고 가독성을 향상시킬 수 있다.

## 목 처리에 대한 모범 사례

### 목은 통합 테스트만을 위한 것

도메인 모델에 대한 테스트는 단위 테스트 범주에 속하며, 컨트롤러(애플리케이션 계층, 프레젠테이션 계층)을 다루는 테스트는 통합 테스트다. 목은 비관리 의존성과의 상호 작용 검증에 사용되며 컨트롤러만 이러한 의존성을 처리하는 코드이기 때문에 통합 테스트에서만 목을 사용해야한다

### 테스트당 목이 하나일 필요는 없음

동작 단위를 검증하는 데 필요한 목의 수는 관계가 없다. 목의 수는 비관리 의존성 수에 의해 결정된다.

### 호출 횟수 검증하기

예상하는 호출이 있는지, 예상치 못한 호출이 있었는지를 반드시 확인해야 한다.

### 보유 타입만 목으로 처리하기

서드파티 라이브러리 위에 항상 어댑터를 작성하고 이 어댑터를 목으로 처리해야 한다. 어댑터를 통해 기본 라이브러리의 복잡성을 추상화하고 필요한 기능만 노출하며 도메인 언어를 사용해 수행할 수 있게 끔 해야 한다. 어댑터로 라이브러리를 추상화 해두면 라이브러리의 코드 변경으로 인한 사이드 이펙트를 어댑터 클래스내로 제한할 수 있다.